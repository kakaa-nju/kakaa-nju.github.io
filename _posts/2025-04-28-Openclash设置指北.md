---
title: Openclash设置指北
date: 2025-04-28 00:44:00 +0800
categories: [Blog, 技术]
tags: [技术, 网络]
---

笔者在昨天尝试重新设置了 Openclash，踩了一些难以定位和找到解决方案的坑，特此记录。

## 环境介绍

笔者的 Openclash 运行在一台 RK3568 的软路由上，系统是 FriendlyWrt 24.10
（硬件厂商提供的对应驱动的改版Openwrt），4G内存，16G eMMc 硬盘。
Openclash 版本是 0.46.079，Meta内核版本是 5.15.112。

笔者需要使用 Openclash的场景有如下三个：
- 在工位的内网下
- 在校园网（路由器的wan）下
- 在校园网外使用 vpn 连接回校园网后

此外，笔者需要设置黑名单模式，让正在做种的机器（之后的文章可能会提到我的这台nas）不经过代理。

## 代理模式的选择

Openclash 支持两种运行模式，分别是 fake-ip 和 redir-host，stfw 和 ask GPT 后对两种模式简单总结如下：

- fake-ip会在 DNS 查询时始终返回一个虚假的 IP 地址，客户机通过这个假 IP 发起的连接会被 Openclash 拦截并代理。
- redir-host 则在 DNS 查询时返回真实 IP，并截获发起连接的包，根据规则进行代理。

可以发现，fake-ip 会使所有流量（即使是访问校园网或国内网站）经过内核，对路由器性能有更高要求，同时可能增加延迟（此外fake-ip模式还存在其他bug）；而 redir-host 虽然不会有这样的问题，但由于需要等待 DNS 查询返回真实结果，在没有命中缓存时延迟可能更高，且可能出现 DNS 污染。

在路由器性能足够的情况下，对于前两个场景 fake-ip 更合适，最后一个场景下也可以通过浏览器插件通过域名分流本地网站使之不经过内核。
但笔者在尝试两种模式后决定最终选择了 redir-host。

### fake-ip 配置

fake-ip 不支持仅代理常用端口，对于 IP 黑名单的支持也存在 bug，在 github 的 issue 中找到解决方案：同时将 IP 和 MAC 添加至黑名单。

### redir-host 配置

没什么特殊的，在校园网下唯一要修改的地方是，启用 IPv6 DNS 查询，否则无法访问 IPv6 站点（是否代理则需要根据需求和机场是否提供而定）。另外，推荐使用配置订阅中的模板转换（而不是一键生成，笔者在试用一键生成时总是无法读取代理服务器相关信息，猜测是使用了特殊字符导致）。